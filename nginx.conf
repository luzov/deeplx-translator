http {
    # 配置多个 DNS 服务器，按顺序尝试
    resolver 
        223.5.5.5     # 阿里 DNS
        223.6.6.6     # 阿里 DNS 备用
        8.8.8.8       # Google DNS
        8.8.4.4       # Google DNS 备用
        114.114.114.114  # 114 DNS
        ipv6=off      # 禁用 IPv6
        valid=300s    # DNS 缓存时间
        ;
    resolver_timeout 5s;  # 解析超时时间
    
    server {
        listen 1199;
        server_name localhost;

        # 静态文件目录
        location / {
            root /usr/share/nginx/html;
            index index.html;
            try_files $uri $uri/ /index.html;
        }

        # 通用API代理配置
        location ~ ^/api/([^/]+)(/.*)? {
            # $1 是主机部分 (host:port 或仅 host)
            # $2 是路径部分 (包括第一个斜杠)
            
            # 解析主机和路径
            set $upstream_host $1;
            set $upstream_path $2;

            # 如果没有路径，设置为/
            if ($upstream_path = '') {
                set $upstream_path /;
            }
            
            # 设置默认协议为 http
            set $upstream_protocol "http";
            
            # 解决重定向问题
            proxy_redirect off;
            proxy_set_header Accept-Encoding '';
            
            # 设置正确的请求头
            proxy_set_header Host $upstream_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 增加错误处理
            proxy_intercept_errors on;
            proxy_next_upstream error timeout http_502;
            
            # 增加缓冲设置
            proxy_buffers 16 4k;
            proxy_buffer_size 2k;
            
            # 增加超时设置
            proxy_connect_timeout 10;
            proxy_send_timeout 10;
            proxy_read_timeout 10;
            
            # 处理 OPTIONS 预检请求
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
                add_header 'Access-Control-Allow-Headers' '*' always;
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain charset=UTF-8';
                add_header 'Content-Length' 0;
                return 204;
            }
            
            # 代理到实际地址
            proxy_pass $upstream_protocol://$upstream_host$upstream_path$is_args$args;
            
            # CORS 设置
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
            add_header 'Access-Control-Allow-Headers' '*' always;
            
            # 解决SSL问题
            proxy_ssl_server_name on;
            proxy_ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
            
            # 错误页面配置
            error_page 502 = @fallback;
        }
        
        # 502错误的备用处理
        location @fallback {
            # 尝试使用HTTPS重试
            set $upstream_host $1;
            set $upstream_path $2;
            set $upstream_protocol "https";
            
            proxy_pass $upstream_protocol://$upstream_host$upstream_path$is_args$args;
            proxy_ssl_server_name on;
            proxy_ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
            
            # 保持相同的请求头
            proxy_set_header Host $upstream_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
